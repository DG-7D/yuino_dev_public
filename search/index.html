<!DOCTYPE html>
<html lang="ja">

<head>
<!-- head_from -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" href="/images/favicons/favicon_yui.ico" id="favicon">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
    <link rel="shortcut icon" type="image/png" sizes="512x512" href="/images/favicons/android-chrome-512x512.png">
    <link rel="manifest" href="/images/favicons/manifest.json">
    <link rel="stylesheet" href="/style.css?3.14">
    <script src="/script.js?3.6" defer></script>
    <script src="/scripts/Omikuji.js" defer></script>
<!-- head_to -->
    <title>ページ内検索 - ゆいのページ</title>
    <meta name="description" content="ページ内検索ができます。">
    <!-- OGP -->
    <meta property="og:title" content="ページ内検索 - ゆいのページ" />
    <meta property="og:image" content="https://yuino.dev/images/thumbnail.png" />
    <meta property="og:description" content="ページ内検索ができます。" />    
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="ゆいのページ" />
</head>

<body>
<!-- header_from -->
<header>
    <div id="header_wrapper">
        <div id="top">
            <h1><a href="/" class="link_inline">ゆいのページ</a></h1>
            <p>にゃーん</p>
        </div>
        <div id="icon">
            <img src="/images/icon.jpg" alt="ゆいのアイコン">
        </div>
        <button id="header_hamburger" onclick="hamburgerMenu()" aria-label="ハンバーガーメニュー">
            <span></span><span></span><span></span>
        </button>
    </div>
</header>
<!-- header_to -->
    <div id="main_wrapper">
    <main>

    <div class="box">
        <h1>ページ内検索</h1>
        <hr class="titlebar">
        <p>ゆいのページ内の検索ができます。</p>
    </div>
    
    <article>
    <section class="box">
        <!-- <h2>検索</h2>
        <hr class="titlebar"> -->
        <p>    
            <form action="/search/index.html" method="get">
                <label for="searchTerm"></label>
                <div class="search_box">
                    <input type="text" name="q" id="searchTerm" placeholder="検索" class="search_input">
                    <button class="search_button" type="submit">
                        <img class="search_mark" src="/images/search.png" alt="検索マーク">
                    </button>
                </div>
            </form>
        </p>
    </section>
    <section class="box">
        <h2>検索結果</h2>
        <hr class="titlebar">
        <p>
            <?php
            error_reporting(0);
            // 検索結果がある場合、表示
            function searchFiles($directory, $searchTerm) {
                $results = array();

                // ディレクトリ内のすべてのファイルとディレクトリを取得
                $files = scandir($directory);

                foreach ($files as $file) {
                    if ($file !== '.' && $file !== '..' && $file[0] !== '.' && $file !== 'error') {
                        $path = $directory . '/' . $file;

                        // ファイルかディレクトリか判定
                        if (is_dir($path)) {
                            // サブディレクトリの場合、再帰的に検索
                            $results = array_merge($results, searchFiles($path, $searchTerm));
                        } else {
                            // HTML ファイルの場合、検索して一致する場合は結果に追加
                            if (pathinfo($path, PATHINFO_EXTENSION) === 'html') {
                                $content = file_get_contents($path);
                                if (stripos($content, $searchTerm) !== false) {
                                    $results[] = $path;
                                }
                            }
                        }
                    }
                }

                return $results;
            }

            // 検索キーワードの取得
            $searchTerm = isset($_GET['q']) ? trim($_GET['q']) : '';

            // サイト内検索対象のディレクトリ
            $searchDirectory = '../'; // content フォルダの中を検索する例

            // 検索結果を格納する配列
            $searchResults = array();
            if (!empty($searchTerm)) {
                $searchResults = searchFiles($searchDirectory, $searchTerm);
            }

            $searchResults = str_replace('..//','../',$searchResults);
            $searchResults2 = str_replace('../','https://yuino.dev/',$searchResults);

            //サイトマップのURL
            $sitemapUrl = '../sitemap/sitemap.xml';

            // サイトマップを取得してXMLを解析
            $sitemapXml = file_get_contents($sitemapUrl);
            $xml = new SimpleXMLElement($sitemapXml);

            // タイトルを格納する配列
            $titles = array();
            $split_num = array();
            $index = -1;

            foreach($searchResults2 as $Resurl){
                // サイトマップ内のURL要素をループで処理
                $index += 1;
                $flag = false;
                foreach ($xml as $url) {
                    if ((string) $url->loc == (string) $Resurl){
                        // タイトルを取得
                        $title = (string)$url->title;
                        // タイトルが空でない場合、配列に追加
                        if (!empty($title)) {
                            $titles[] = $title;
                            $flag = true;
                        }
                        continue;
                    }
                }
                if (!$flag){
                    $split_num[] = $index;
                }
            }

            //タイトルが存在しないページを配列から削除
            foreach ($split_num as $i){
                unset($searchResults[$i]);
            }
            $searchResults = array_values($searchResults);

            if($searchTerm!=null){
                // $Search = htmlspecialchars($searchResults);
                echo '検索: ' . htmlspecialchars($searchTerm) . '<br>';
                if ($searchResults!=null) {
                    // $URL = htmlspecialchars(json_decode($_GET['URL']));
                    // $Title = htmlspecialchars(json_decode($_GET['Title']));
                    echo '<ul>';
                    for ($i=0; $i < count($titles); $i++) { 
                        echo '<li><a href="' . htmlspecialchars($searchResults[$i]) . '">' . htmlspecialchars($titles[$i]) . '</a></li>';   
                    }
                    echo '</ul>';
                }else{
                    echo '見つかりませんでした。';
                }
            }else{
                echo '検索欄にテキストを入力してください...';
            }
            ?>
        </p>
    </section>
    </article>

    </main>
<!-- aside_from -->
    <div id="aside_background" onclick="hamburgerMenu()"></div>
    <aside>
        <nav class="box">
            <h2>コンテンツ</h2>
            <hr class="titlebar">
            <div>
                <a href="/" class="aside_link_box">トップ</a>
                <a href="/blog/" class="aside_link_box">ブログ</a>
                <a href="/works/" class="aside_link_box">作品</a>
                <a href="/album/" class="aside_link_box">アルバム</a>
                <a href="/sns/" class="aside_link_box">SNS</a>
                <a href="/others/" class="aside_link_box">その他</a>
            </div>
        </nav>
        <div class="box">
            <h2>ページ内検索</h2>
            <hr class="titlebar">
            <p>ページ内の検索ができます。
                <form action="/search/index.html" method="get">
                    <label for="searchTerm"></label>
                    <div class="search_box">
                        <input type="text" name="q" id="searchTerm" placeholder="検索" class="search_input">
                        <button class="search_button" type="submit">
                            <img class="search_mark" src="/images/search.png" alt="検索マーク">
                        </button>
                    </div>
                </form>
            </p>
        </div>
        <div class="box">
            <h2>カウンター</h2>
            <?php include($_SERVER['DOCUMENT_ROOT'] . '/counter/counter.php'); ?>
            <hr class="titlebar">
            <p class="counter">
                今日のアクセス数<br>
                <span id="counter_today" class="counter_num">0</span>
                合計のアクセス数<br>
                <span id="counter_all" class="counter_num">0</span>
                <a href="/counter/">詳細</a>
            </p>
        </div>
        <div class="box">
            <h2>おみくじ</h2>
            <hr class="titlebar">
            <button id="omikuji" class="center" onclick="omikuji()">
                おみくじをひく
            </button>
        </div>
    </aside>
    <div id="card">
        <div id="card_background" onclick="ClosePanel('Add')"></div>
        <div id="card_contents">
            <button id="card_close" class="center" onclick="ClosePanel('Add')"><div>×</div></button>
            <div id="card_title" class="center"></div>
            <div id="card_message" class="center"></div>
        </div>
    </div>
<!-- aside_to -->
    </div>

<!-- footer_from -->
    <button id="scrollToTopButton">
        <div><right></right><left></left></div>
    </button>
    <footer>
        <a href="/sitemap/">サイトマップ</a><br>
        &copy; 2023-2024 ゆうきゆい
    </footer>
<!-- footer_to -->

</body>
</html>